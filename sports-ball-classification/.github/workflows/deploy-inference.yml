name: Deploy Inference API

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        default: "deploy"
        type: choice
        options:
          - deploy
          - stop
          - restart
          - logs
          - test

  push:
    branches:
      - main
      - master
    paths:
      - "examen/sports-ball-classification/inference/**"

jobs:
  # ============================================================================
  # Deploy Inference API to Local Machine (Self-Hosted Runner)
  # ============================================================================
  deploy:
    name: ğŸ³ Deploy Inference API
    runs-on: self-hosted
    if: ${{ github.event.inputs.action == 'deploy' || github.event.inputs.action == 'restart' || github.event.inputs.action == '' || github.event_name == 'push' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display deployment info
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘        ğŸ³ Deploying Sports Ball Classification API         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ–¥ï¸  Host: $(hostname)"
          echo "ğŸ“ Working directory: $(pwd)"
          echo "ğŸ¯ Action: ${{ github.event.inputs.action || 'deploy' }}"
          echo ""

      - name: Stop existing containers
        working-directory: examen/sports-ball-classification/inference
        run: |
          echo "ğŸ›‘ Stopping existing containers..."
          docker-compose down || true
          echo "âœ… Containers stopped"

      - name: Build Docker images
        working-directory: examen/sports-ball-classification/inference
        run: |
          echo "ğŸ”¨ Building Docker images..."
          docker-compose build
          echo "âœ… Build complete"

      - name: Start containers
        working-directory: examen/sports-ball-classification/inference
        run: |
          echo "ğŸš€ Starting containers..."
          docker-compose up -d
          echo "âœ… Containers started"

      - name: Wait for services to be ready
        run: |
          echo "â³ Waiting for services to start..."
          sleep 15

      - name: Health check
        run: |
          echo "ğŸ¥ Running health check..."
          for i in {1..10}; do
            if curl -s http://localhost:8000/health | grep -q "healthy"; then
              echo "âœ… API is healthy!"
              exit 0
            fi
            echo "   Waiting for API... (attempt $i/10)"
            sleep 5
          done
          echo "âš ï¸ Health check timed out, but containers may still be starting"

      - name: Display deployment summary
        working-directory: examen/sports-ball-classification/inference
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           ğŸ‰ Inference API Deployed!                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¡ API Endpoints:"
          echo "   â€¢ Swagger UI: http://localhost:8000/docs"
          echo "   â€¢ Health:     http://localhost:8000/health"
          echo "   â€¢ Predict:    http://localhost:8000/predict"
          echo "   â€¢ Categories: http://localhost:8000/categories"
          echo "   â€¢ Stats:      http://localhost:8000/stats"
          echo ""
          echo "ğŸ“Š Container status:"
          docker-compose ps
          echo ""

  # ============================================================================
  # Stop Inference API
  # ============================================================================
  stop:
    name: ğŸ›‘ Stop Inference API
    runs-on: self-hosted
    if: ${{ github.event.inputs.action == 'stop' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Stop containers
        working-directory: examen/sports-ball-classification/inference
        run: |
          echo "ğŸ›‘ Stopping inference API..."
          docker-compose down
          echo "âœ… All containers stopped"

      - name: Show status
        working-directory: examen/sports-ball-classification/inference
        run: |
          echo "ğŸ“Š Container status:"
          docker-compose ps || echo "No containers running"

  # ============================================================================
  # Show Logs
  # ============================================================================
  logs:
    name: ğŸ“‹ Show Logs
    runs-on: self-hosted
    if: ${{ github.event.inputs.action == 'logs' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show container logs
        working-directory: examen/sports-ball-classification/inference
        run: |
          echo "ğŸ“‹ Last 100 lines of logs:"
          echo ""
          docker-compose logs --tail=100

  # ============================================================================
  # Test API
  # ============================================================================
  test:
    name: ğŸ§ª Test API
    runs-on: self-hosted
    if: ${{ github.event.inputs.action == 'test' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test health endpoint
        run: |
          echo "ğŸ§ª Testing API endpoints..."
          echo ""
          echo "1ï¸âƒ£ Health check:"
          curl -s http://localhost:8000/health | python3 -m json.tool || curl -s http://localhost:8000/health
          echo ""

      - name: Test categories endpoint
        run: |
          echo "2ï¸âƒ£ Categories:"
          curl -s http://localhost:8000/categories | python3 -m json.tool || curl -s http://localhost:8000/categories
          echo ""

      - name: Test stats endpoint
        run: |
          echo "3ï¸âƒ£ Stats:"
          curl -s http://localhost:8000/stats | python3 -m json.tool || curl -s http://localhost:8000/stats
          echo ""

      - name: Test prediction with sample image
        working-directory: examen
        run: |
          echo "4ï¸âƒ£ Testing prediction..."
          SAMPLE_IMAGE=$(find data -name "*.jpg" | head -1)
          if [ -n "$SAMPLE_IMAGE" ]; then
            echo "   Using sample image: $SAMPLE_IMAGE"
            curl -s -X POST "http://localhost:8000/predict" \
              -H "accept: application/json" \
              -H "Content-Type: multipart/form-data" \
              -F "img=@$SAMPLE_IMAGE" | python3 -m json.tool || echo "Prediction request completed"
          else
            echo "   No sample images found in data folder"
          fi
          echo ""

      - name: Test summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              âœ… API Tests Complete!                         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
